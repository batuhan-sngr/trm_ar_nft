<!doctype html>
<html lang="en">
<head>
  <meta charset="ub-8" />
  <title>Dark Souls AR - The Forgotten Path</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame (NFT support) -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; background: #000; }
    
    .narrative-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex; align-items: center; justify-content: center;
      z-index: 100; pointer-events: none;
      opacity: 0; transition: opacity 1s ease;
    }
    .narrative-overlay.show { opacity: 1; }
    .narrative-text {
      max-width: 600px; padding: 40px;
      font: 400 18px/1.6 'Crimson Text', Georgia, serif;
      color: #d4c5a9; text-align: center;
      text-shadow: 0 0 20px rgba(0,0,0,0.8);
      letter-spacing: 0.5px;
    }

    .hud {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      font: 600 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: #d4c5a9; text-align: center;
      text-shadow: 0 2px 8px rgba(0,0,0,0.9);
      z-index: 10; pointer-events: none;
      max-width: 90%; padding: 0 20px;
    }
    .hud.hidden { display: none; }
    
    .souls-counter {
      position: fixed; top: 20px; right: 20px;
      font: 700 24px/1 'Cinzel', serif;
      color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.5);
      z-index: 10; display: none;
    }
    .souls-counter.show { display: block; }

    .title-screen {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle, #1a1a1a 0%, #000000 100%);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 200; transition: opacity 1.5s ease;
    }
    .title-screen.hide { opacity: 0; pointer-events: none; }
    .title-screen h1 {
      font: 700 48px/1.2 'Cinzel', serif;
      color: #d4c5a9; margin: 0 0 20px 0;
      text-shadow: 0 0 30px rgba(212,197,169,0.3);
      letter-spacing: 4px;
    }
    .title-screen p {
      font: 400 16px/1.6 'Crimson Text', Georgia, serif;
      color: #888; max-width: 500px; text-align: center;
      padding: 0 20px; margin: 0 0 40px 0;
    }
    .start-btn {
      padding: 15px 40px; border: 2px solid #d4c5a9;
      background: rgba(0,0,0,0.5); color: #d4c5a9;
      font: 600 16px/1 'Cinzel', serif;
      cursor: pointer; transition: all 0.3s ease;
      letter-spacing: 2px;
    }
    .start-btn:hover {
      background: rgba(212,197,169,0.2);
      box-shadow: 0 0 20px rgba(212,197,169,0.3);
    }
  </style>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">

  <script>
  // ---------- Game State Manager ----------
  const GameState = {
    phase: 0, // 0=bonfire, 1=sword, 2=boss, 3=ending
    soulsCollected: 0,
    bonfireLit: false,
    swordClaimed: false,
    bossDefeated: false,
    
    advance(newPhase) {
      this.phase = newPhase;
      this.updateNarrative();
    },
    
    updateNarrative() {
      const narratives = [
        "In the depths of a forsaken land, a lone bonfire flickers...\n\nTouch the flame to begin your journey.",
        "The bonfire burns bright. Ahead lies a weapon of legend.\n\nClaim the blade that has felled countless hollows.",
        "Armed and ablaze, you face the ancient guardian.\n\nOnly by defeating this sentinel can you escape the darkness.",
        "The dragon falls. The curse is lifted.\n\nYou have kindled the flame of hope in a world of despair."
      ];
      
      showNarrative(narratives[this.phase]);
    },
    
    collectSoul() {
      this.soulsCollected++;
      updateSoulsDisplay();
    }
  };

  function showNarrative(text) {
    const overlay = document.getElementById('narrative');
    const textEl = document.getElementById('narrative-text');
    textEl.innerText = text;
    overlay.classList.add('show');
    setTimeout(() => overlay.classList.remove('show'), 5000);
  }

  function updateHUD(text) {
    const hud = document.getElementById('hud');
    hud.innerText = text;
  }

  function updateSoulsDisplay() {
    const counter = document.getElementById('souls-counter');
    counter.innerText = `Souls: ${GameState.soulsCollected}`;
    counter.classList.add('show');
  }

  // ---------- Interactive Components ----------
  
  // Bonfire interaction
  AFRAME.registerComponent('bonfire-interactive', {
    init() {
      this.lit = false;
      const fire = () => {
        if (!this.lit && GameState.phase === 0) {
          this.lit = true;
          this.el.emit('ignite');
          GameState.bonfireLit = true;
          GameState.advance(1);
          updateHUD('The bonfire is lit. Seek the blade ahead.');
          
          setTimeout(() => {
            updateHUD('Scan for the legendary blade...');
          }, 3000);
        }
      };
      this.el.addEventListener('click', fire);
      this.el.addEventListener('touchstart', fire);
    }
  });

  // Sword interaction
  AFRAME.registerComponent('sword-interactive', {
    init() {
      this.claimed = false;
      const claim = () => {
        if (!this.claimed && GameState.bonfireLit && GameState.phase === 1) {
          this.claimed = true;
          this.el.emit('claim');
          GameState.swordClaimed = true;
          GameState.advance(2);
          updateHUD('Blade in hand. The guardian awaits...');
          
          setTimeout(() => {
            updateHUD('Scan for the ancient guardian...');
          }, 3000);
        } else if (!GameState.bonfireLit) {
          updateHUD('Light the bonfire first...');
        }
      };
      this.el.addEventListener('click', claim);
      this.el.addEventListener('touchstart', claim);
    }
  });

  // Boss interaction
  AFRAME.registerComponent('boss-interactive', {
    schema: { health: {default: 5} },
    init() {
      this.health = this.data.health;
      this.defeated = false;
      
      const attack = () => {
        if (!this.defeated && GameState.swordClaimed && GameState.phase === 2) {
          this.health--;
          this.el.emit('damage');
          GameState.collectSoul();
          
          if (this.health <= 0) {
            this.defeated = true;
            this.el.emit('defeat');
            GameState.bossDefeated = true;
            GameState.advance(3);
            updateHUD('Victory achieved. The path is clear.');
          } else {
            updateHUD(`Guardian weakens... (${this.health} souls remaining)`);
          }
        } else if (!GameState.swordClaimed) {
          updateHUD('You need a weapon to face this foe...');
        }
      };
      
      this.el.addEventListener('click', attack);
      this.el.addEventListener('touchstart', attack);
    }
  });

  // Floating animation
  AFRAME.registerComponent('float', {
    schema: { speed: {default: 3000}, distance: {default: 0.2} },
    init() {
      const pos = this.el.getAttribute('position');
      this.el.setAttribute('animation__float', 
        `property: position; to: ${pos.x} ${pos.y + this.data.distance} ${pos.z}; dur: ${this.data.speed}; loop: true; dir: alternate; easing: easeInOutSine`);
    }
  });

  // Pulse glow
  AFRAME.registerComponent('pulse-glow', {
    schema: { speed: {default: 2000} },
    init() {
      this.el.setAttribute('animation__pulse',
        `property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dur: ${this.data.speed}; loop: true; dir: alternate; easing: easeInOutSine`);
    }
  });
  </script>
</head>
<body>
  
  <!-- Title Screen -->
  <div class="title-screen" id="title-screen">
    <h1>THE FORGOTTEN PATH</h1>
    <p>In a realm consumed by darkness, three markers hold the key to salvation. Light the bonfire. Claim the blade. Defeat the guardian.</p>
    <button class="start-btn" id="start-btn">BEGIN JOURNEY</button>
  </div>

  <!-- Narrative Overlay -->
  <div class="narrative-overlay" id="narrative">
    <div class="narrative-text" id="narrative-text"></div>
  </div>

  <!-- HUD -->
  <div class="hud" id="hud">Seek the bonfire to begin...</div>
  
  <!-- Souls Counter -->
  <div class="souls-counter" id="souls-counter">Souls: 0</div>

  <a-scene
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: true; detectionMode: mono_and_matrix;"
    loading-screen="enabled: false">

    <!-- Cursor for interaction -->
    <a-entity cursor="rayOrigin: mouse; fuse: true; fuseTimeout: 500" 
              raycaster="objects: .interactive; far: 100"
              position="0 0 -1"
              geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
              material="color: #d4c5a9; shader: flat; opacity: 0.8"
              animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.5 0.5 0.5; dur: 500"
              animation__fusecomplete="property: scale; startEvents: click; from: 0.5 0.5 0.5; to: 1 1 1; dur: 150"></a-entity>

    <!-- Ambient lighting -->
    <a-entity light="type: ambient; intensity: 1; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 1; color: #ffffff" position="1 1 1"></a-entity>
    <a-entity light="type: directional; intensity: 0.5; color: #ffffff" position="-1 1 -1"></a-entity>

    <!-- MARKER 1: BONFIRE (NFT) -->
    <a-nft
      type="nft"
      url="nft/bonfire"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5">
      
      <!-- Bonfire GLB Model -->
      <a-entity 
        glb-model="./models/bonfire.glb"
        class="interactive"
        bonfire-interactive
        model-debug
        position="0 0.5 1"
        scale="2 2 2"
        rotation="0 0 0">
        
        <!-- Additional glow effect -->
        <a-entity light="type: point; intensity: 2; color: #ff6600; distance: 3; decay: 1" position="0 0.5 0"></a-entity>
      </a-entity>
    </a-nft>

    <!-- MARKER 2: SWORD (NFT) -->
    <a-nft
      type="nft"
      url="nft/sword"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5">
      
      <!-- Sword GLB Model -->
      <a-entity 
        glb-model="./models/Sword.glb"
        class="interactive"
        sword-interactive
        model-debug
        position="0 1 1"
        scale="2 2 2"
        rotation="-90 0 0"
        float="speed: 4000; distance: 0.15">
        
        <!-- Mystical glow -->
        <a-entity light="type: point; intensity: 1.5; color: #4da6ff; distance: 2" position="0 0 0"></a-entity>
      </a-entity>
    </a-nft>

    <!-- MARKER 3: DRAGON BOSS (NFT) -->
    <a-nft
      type="nft"
      url="nft/dragon"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5">
      
      <!-- Dragon GLB Model -->
      <a-entity 
        glb-model="./models/dragon.glb"
        class="interactive"
        boss-interactive="health: 5"
        model-debug
        position="0 0.5 1"
        scale="2 2 2"
        rotation="0 180 0"
        animation__idle="property: rotation; to: 0 540 0; dur: 20000; loop: true; easing: linear">
        
        <!-- Ominous red glow -->
        <a-entity light="type: point; intensity: 2; color: #ff0000; distance: 4; decay: 1" position="0 0.5 0"></a-entity>
      </a-entity>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // GLB Model Loading Debug
    AFRAME.registerComponent('model-debug', {
      init() {
        this.el.addEventListener('model-loaded', () => {
          console.log('✅ Model loaded successfully:', this.el.getAttribute('glb-model'));
          updateHUD('3D Model loaded!');
        });
        this.el.addEventListener('model-error', (e) => {
          console.error('❌ Model loading error:', e.detail);
          updateHUD('Model failed to load - check console');
        });
      }
    });

    // Title screen
    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('title-screen').classList.add('hide');
      GameState.updateNarrative();
    });

    // Bonfire ignite animation
    document.querySelector('[bonfire-interactive]').addEventListener('ignite', (e) => {
      const bonfire = e.target;
      // Enhance lighting
      const light = bonfire.querySelector('[light]');
      if (light) {
        light.setAttribute('light', 'intensity', 2);
      }
      // Scale up slightly
      bonfire.setAttribute('animation__ignite', 'property: scale; to: 0.6 0.6 0.6; dur: 1000; easing: easeOutElastic');
    });

    // Sword claim animation
    document.querySelector('[sword-interactive]').addEventListener('claim', (e) => {
      const sword = e.target;
      sword.setAttribute('animation__claim', 'property: position; to: 0 2 0; dur: 2000; easing: easeInOutCubic');
      sword.setAttribute('animation__spin', 'property: rotation; to: 0 720 0; dur: 2000; easing: easeInOutCubic');
      setTimeout(() => {
        sword.setAttribute('visible', 'false');
      }, 2000);
    });

    // Boss damage animation
    document.querySelector('[boss-interactive]').addEventListener('damage', (e) => {
      const boss = e.target;
      boss.setAttribute('animation__damage', 'property: scale; to: 0.35 0.35 0.35; dur: 200; dir: alternate; loop: 2');
      
      // Flash effect
      const light = boss.querySelector('[light]');
      if (light) {
        light.setAttribute('animation__flash', 'property: light.intensity; to: 2; dur: 200; dir: alternate; loop: 2');
      }
    });

    // Boss defeat animation
    document.querySelector('[boss-interactive]').addEventListener('defeat', (e) => {
      const boss = e.target;
      boss.setAttribute('animation__fall', 'property: position; to: 0 -1 0; dur: 2000; easing: easeInCubic');
      boss.setAttribute('animation__dissolve', 'property: scale; to: 0 0 0; dur: 2000; easing: easeInCubic');
    });

    // NFT Debug logging
    window.addEventListener('arjs-nft-loaded', (e) => {
      console.log('NFT Marker Loaded!', e.detail);
      updateHUD('Marker detected! Look at the object.');
    });
  </script>
</body>
</html>